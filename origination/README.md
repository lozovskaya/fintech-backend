# Origination

## Принцип работы

Сервис Origination занимается приемом заявок на кредит, прогоном их через Scoring и зачислением денег на счета клиентам.

Flow процесса устроен следующим образом:

1. От клиенского сервиса API приходит заявка на кредит.
    Заявка на кредит выглядит следующим образом: {client_id (информация о клиенте), product_id (какой продукт он хочет взять), disbursement_amount (сумма кредита), term (срок), interest (желаемый процесс)}

2. После получения заявки сервис делает запрос на сервис Product Engine о том, корректные ли данные (например, что можно взять кредит на желаемый срок). Если заявка верная, то ручка отдает 200 "Заявка создана" (не значит, что заявка уже была одобрена).

3. Сервис записывает заявку в базу данных со статусом Created, и отправляет заявку в сервис Scoring с помощью бекграудной задачи. Если отправка была успешной, то статус меняется на Pending. Scoring может потенциально занимать много времени. 

4. После ответа сервиса Scoring, заявка меняется в базе данных на статус Approved / Rejected

5. (?) Если ответ от Scoring положительный, сервис отправляет заявку на сервис Product Engine и создает заявку на  (product_engine/create_agreement), получая обратно id созданной заявки.

В случае отмены заявки:

1. Если заявка была в статусе Pending, дополнительно вызывается ручка отмены заявки на сервис Scoring.

2. Если заявка имеет статус 

3. Статус заявки меняется на Cancelled.

База данных необходима в случае, если сервис упадет, в этом случае заявки останутся в базе данных, и при перезапуске сервиса все заявки со статусом Created будут перезапущены.

Дубли разрешаются следующим образом: если пришла заявка, которая уже лежит в БД (и статус не Rejected) или если разница между заявками меньше 5 минут, то заявка автоматически отлоняется. В API возвращается id уже созданной заявки, если она была создана.

Существует отдельная мастер-таска, которая делает следующее: раз в какое-то она вытаскивает из базы данных все заявки в статусе Created (заявка создалась, но не была отправлена в Scoring / сервис Scoring упал с ошибкой 500 и тд), и переотправляет заявку в Scoring. 

## Ручки сервиса:

- `POST /application`

Возвращает код с определенным телом:
```
200 - успешно созданная заявка на кредит
{
  "application_id: 123
}

409 - в сервис поступил "дубль" заявки на кредит, заявка будет автоматически закрыта
{
  "application_id": 123
}
```

- `POST /application/{application_id}/close`

Возвращает код без тела:
```
200 - Заявка с указанным ID была успешно закрыта
404 - Заявка с указанным ID не существует
```
У клиента должна быть возможность отменить созданную им заявку на кредит. Именно это должно быть сделано этим методом. Если заявка успела уйти на Scoring - она должна отмениться и там.

- `GET /application/{application_id}/get`

Возвращает код с телом:
```
200 - Возвращает статус указанной заявки (Pending (ожидает результат от Scoring) / Approved (заявка на кредит одобрена) / Rejected (заявка на кредит отклонена) / Cancelled (клиент отменил созданную заявку) / Created (Заявка была создана))
404 - Заявка с указанным ID не существует
```

## To run Docker:

```bash
docker build -t origination .
docker run -d --network="fintech-network" --name origination -p 90:90 origination
```

to re-run it, do not forget to do this before running a container
```bash
docker stop origination
docker rm origination 
```
